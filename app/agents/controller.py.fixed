from flask import current_app, Blueprint, request, session
import json
import os
from app.agents.schemas import AgentMessage, QuizChoice
from app.agents.prompts import (
    create_system_prompt, 
    create_greeter_prompt, 
    create_completion_prompt,
    create_portfolio_prompt
)
from app.models.language import detect_language, get_text_by_key
from app.models.tech_spec import TechSpecTemplate
from app.services.logger import logger

# Agents configuration
agent_bp = Blueprint('agent', __name__, url_prefix='/api/agent')

# Available specialists/agents for the chat
SPECIALISTS = {
    'greeter': {
        'name': 'greeter',
        'title': {
            'en': 'Greeter',
            'ru': '–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π',
            'de': 'Greeter'
        },
        'description': {
            'en': 'I can help you choose the right specialist or service.',
            'ru': '–Ø –ø–æ–º–æ–≥—É –≤–∞–º –≤—ã–±—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –∏–ª–∏ —É—Å–ª—É–≥—É.',
            'de': 'Ich kann Ihnen helfen, den richtigen Spezialisten oder Dienst zu w√§hlen.'
        },
        'avatar': '/static/img/agents/greeter.png'
    },
    'design': {
        'name': 'design',
        'title': {
            'en': 'Designer',
            'ru': '–î–∏–∑–∞–π–Ω–µ—Ä',
            'de': 'Designer'
        },
        'description': {
            'en': 'I can help with web design questions, UI/UX, and graphic design.',
            'ru': '–Ø –º–æ–≥—É –ø–æ–º–æ—á—å —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –≤–µ–±-–¥–∏–∑–∞–π–Ω–∞, UI/UX –∏ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞.',
            'de': 'Ich kann bei Fragen zu Webdesign, UI/UX und Grafikdesign helfen.'
        },
        'avatar': '/static/img/agents/design.png'
    },
    'development': {
        'name': 'development',
        'title': {
            'en': 'Developer',
            'ru': '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫',
            'de': 'Entwickler'
        },
        'description': {
            'en': 'I specialize in web development, programming and technical questions.',
            'ru': '–Ø —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Å—å –Ω–∞ –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ, –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö.',
            'de': 'Ich bin spezialisiert auf Webentwicklung, Programmierung und technische Fragen.'
        },
        'avatar': '/static/img/agents/development.png'
    },
    'marketing': {
        'name': 'marketing',
        'title': {
            'en': 'Marketing Expert',
            'ru': '–ú–∞—Ä–∫–µ—Ç–æ–ª–æ–≥',
            'de': 'Marketing-Experte'
        },
        'description': {
            'en': 'I can help with digital marketing, SEO, and promotion strategies.',
            'ru': '–Ø –ø–æ–º–æ–≥—É —Å —Ü–∏—Ñ—Ä–æ–≤—ã–º –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–º, SEO –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º–∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è.',
            'de': 'Ich kann bei digitalem Marketing, SEO und Werbestrategien helfen.'
        },
        'avatar': '/static/img/agents/marketing.png'
    },
    'portfolio': {
        'name': 'portfolio',
        'title': {
            'en': 'Portfolio Navigator',
            'ru': '–ù–∞–≤–∏–≥–∞—Ç–æ—Ä –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ',
            'de': 'Portfolio-Navigator'
        },
        'description': {
            'en': 'I can show you our works, projects and case studies.',
            'ru': '–Ø –º–æ–≥—É –ø–æ–∫–∞–∑–∞—Ç—å –Ω–∞—à–∏ —Ä–∞–±–æ—Ç—ã, –ø—Ä–æ–µ–∫—Ç—ã –∏ –∫–µ–π—Å—ã.',
            'de': 'Ich kann Ihnen unsere Arbeiten, Projekte und Fallstudien zeigen.'
        },
        'avatar': '/static/img/agents/portfolio.png'
    },
    'requirements': {
        'name': 'requirements',
        'title': {
            'en': 'Technical Specification Assistant',
            'ru': '–ü–æ–º–æ—â–Ω–∏–∫ –ø–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º—É –∑–∞–¥–∞–Ω–∏—é',
            'de': 'Technischer Spezifikationsassistent'
        },
        'description': {
            'en': 'I can help create a technical specification for your project.',
            'ru': '–Ø –ø–æ–º–æ–≥—É —Å–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –¥–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞.',
            'de': 'Ich kann bei der Erstellung einer technischen Spezifikation f√ºr Ihr Projekt helfen.'
        },
        'avatar': '/static/img/agents/requirements.png'
    },
    'quiz': {
        'name': 'quiz',
        'title': {
            'en': 'Website Cost Calculator',
            'ru': '–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Å–∞–π—Ç–∞',
            'de': 'Website-Kostenrechner'
        },
        'description': {
            'en': 'I can help you calculate an approximate cost of your website.',
            'ru': '–Ø –ø–æ–º–æ–≥—É —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø—Ä–∏–º–µ—Ä–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤–∞—à–µ–≥–æ —Å–∞–π—Ç–∞.',
            'de': 'Ich kann Ihnen helfen, die ungef√§hren Kosten Ihrer Website zu berechnen.'
        },
        'avatar': '/static/img/agents/quiz.png'
    }
}

# Route for incoming agent messages
@agent_bp.route('/message', methods=['POST'])
def agent_message():
    """Handle incoming messages from the user to the agent"""
    message_data = request.json
    user_message = message_data.get('message')
    metadata = message_data.get('metadata', {})
    
    # Detect language of the user message
    if user_message:
        detected_lang = detect_language(user_message)
        if detected_lang:
            metadata['language'] = detected_lang
    
    # If no language is detected or set, default to English
    if 'language' not in metadata:
        metadata['language'] = 'en'
    
    # Process the message and get response
    response = route_and_respond(user_message, metadata)
    
    # Convert to JSON and return
    return json.dumps(response)

def route_and_respond(message, metadata=None):
    """Route the message to the appropriate agent and get a response"""
    if metadata is None:
        metadata = {}
    
    # Get the language from metadata or default to English
    language = metadata.get('language', 'en')
    
    # Check if a specific agent is already selected or active
    active_specialist = metadata.get('active_specialist')
    selected_agent = metadata.get('selected_agent')
    
    # If we're in a quiz session, always use the quiz agent
    if metadata.get('quiz_started'):
        return handle_quiz(message, metadata)
    
    # If we're in a tech spec creation session, use the requirements agent
    if metadata.get('tech_spec_started'):
        return handle_tech_spec_creation(message, metadata)
        
    # If a user selects a specific agent
    if message and message.isdigit() and int(message) > 0 and int(message) <= len(SPECIALISTS):
        # Convert 1-based index from the UI to 0-based index for the list
        specialist_idx = int(message) - 1
        specialist_key = list(SPECIALISTS.keys())[specialist_idx]
        return handle_specialist_selection(specialist_key, metadata)
    
    # If a specialist is already active
    if active_specialist:
        # Check if the user is trying to go back to the greeter
        if message and message.lower() in ['back', '–Ω–∞–∑–∞–¥', 'zur√ºck']:
            # Clear specialist selection
            metadata.pop('selected_agent', None)
            metadata.pop('active_specialist', None)
            return handle_greeter(metadata)
        
        # Otherwise, forward to the appropriate specialist handler
        if active_specialist == 'portfolio':
            return handle_portfolio(message, metadata)
        elif active_specialist == 'quiz':
            return handle_quiz(message, metadata)
        elif active_specialist == 'requirements':
            return handle_tech_spec_creation(message, metadata)
        else:
            return handle_generic_agent(message, active_specialist, metadata)
    
    # If a specific agent is selected but not yet activated
    if selected_agent:
        # Activate the selected specialist
        metadata['active_specialist'] = selected_agent
        
        if selected_agent == 'greeter':
            return handle_greeter(metadata)
        elif selected_agent == 'portfolio':
            return handle_portfolio(None, metadata)
        elif selected_agent == 'quiz':
            return handle_quiz(None, metadata)
        elif selected_agent == 'requirements':
            return handle_tech_spec_creation(None, metadata)
        else:
            return handle_generic_agent(None, selected_agent, metadata)
    
    # Default case: use the greeter
    return handle_greeter(metadata)

def handle_greeter(metadata):
    """Handle messages for the greeter agent"""
    language = metadata.get('language', 'en')
    
    # Create specialized prompt for the greeter
    system_prompt = create_system_prompt('greeter', language)
    user_prompt = create_greeter_prompt(language, SPECIALISTS)
    
    # Get response from AI model
    response_text = "Hello! I'm the Rozoom AI assistant. How can I help you today?"
    if language == 'ru':
        response_text = "–ü—Ä–∏–≤–µ—Ç! –Ø AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç Rozoom. –ö–∞–∫ —è –º–æ–≥—É –≤–∞–º –ø–æ–º–æ—á—å —Å–µ–≥–æ–¥–Ω—è?"
    elif language == 'de':
        response_text = "Hallo! Ich bin der Rozoom KI-Assistent. Wie kann ich Ihnen heute helfen?"
    
    # Create buttons for each specialist
    buttons = []
    for i, (key, specialist) in enumerate(SPECIALISTS.items()):
        buttons.append({
            'text': specialist['title'].get(language, specialist['title']['en']),
            'value': str(i+1),
            'description': specialist['description'].get(language, specialist['description']['en']),
            'avatar': specialist['avatar']
        })
    
    return {
        'agent': 'greeter',
        'answer': response_text,
        'interactive': {
            'text': response_text,
            'buttons': buttons,
            'requires_input': True,
            'meta': {'agent': 'greeter'}
        }
    }

def handle_specialist_selection(specialist_key, metadata):
    """Handle when a user selects a specific specialist"""
    # Store the selected agent in the metadata
    metadata['selected_agent'] = specialist_key
    
    # Route back to the main handler with the updated metadata
    return route_and_respond(None, metadata)

def handle_generic_agent(message, agent_name, metadata):
    """Handle messages for generic agents (design, development, marketing)"""
    language = metadata.get('language', 'en')
    
    # Create specialized prompt for the agent
    system_prompt = create_system_prompt(agent_name, language)
    user_prompt = message or get_text_by_key(f"{agent_name}_greeting", language)
    
    # Get response from AI model
    response_text = f"I'm your {SPECIALISTS[agent_name]['title']['en']} assistant. How can I help with your {agent_name} needs?"
    if language == 'ru':
        response_text = f"–Ø –≤–∞—à –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ {SPECIALISTS[agent_name]['title']['ru']}. –ö–∞–∫ —è –º–æ–≥—É –ø–æ–º–æ—á—å —Å –≤–∞—à–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏ –æ {agent_name}?"
    elif language == 'de':
        response_text = f"Ich bin Ihr {SPECIALISTS[agent_name]['title']['de']} Assistent. Wie kann ich Ihnen bei Ihren {agent_name}-Anforderungen helfen?"
    
    # Only include a back button
    buttons = [{
        'text': 'Back' if language == 'en' else ('–ù–∞–∑–∞–¥' if language == 'ru' else 'Zur√ºck'),
        'value': 'back',
        'description': 'Return to specialist selection' if language == 'en' else 
                      ('–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—ã–±–æ—Ä—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞' if language == 'ru' else 
                       'Zur√ºck zur Spezialistenauswahl')
    }]
    
    return {
        'agent': agent_name,
        'answer': response_text,
        'interactive': {
            'text': response_text,
            'buttons': buttons,
            'requires_input': True,
            'meta': {'agent': agent_name}
        }
    }

def handle_portfolio(message, metadata):
    """Handle messages for the portfolio agent"""
    language = metadata.get('language', 'en')
    
    # Create specialized prompt for the portfolio agent
    system_prompt = create_system_prompt('portfolio', language)
    user_prompt = create_portfolio_prompt(language)
    
    # If this is the initial message (no user query yet)
    if not message:
        # Initial portfolio greeting
        greeting = "Here's our portfolio of recent projects. What kind of projects are you interested in seeing?"
        if language == 'ru':
            greeting = "–í–æ—Ç –Ω–∞—à–µ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ –Ω–µ–¥–∞–≤–Ω–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤. –ö–∞–∫–∏–µ —Ç–∏–ø—ã –ø—Ä–æ–µ–∫—Ç–æ–≤ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç?"
        elif language == 'de':
            greeting = "Hier ist unser Portfolio der neuesten Projekte. An welcher Art von Projekten sind Sie interessiert?"
        
        # Sample portfolio categories as buttons
        buttons = [
            {
                'text': 'E-commerce' if language == 'en' else ('–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω—ã' if language == 'ru' else 'E-Commerce'),
                'value': 'ecommerce',
                'description': 'Online stores and marketplaces' if language == 'en' else 
                              ('–û–Ω–ª–∞–π–Ω –º–∞–≥–∞–∑–∏–Ω—ã –∏ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—ã' if language == 'ru' else 
                               'Online-Shops und Marktpl√§tze')
            },
            {
                'text': 'Corporate websites' if language == 'en' else ('–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —Å–∞–π—Ç—ã' if language == 'ru' else 'Unternehmenswebsites'),
                'value': 'corporate',
                'description': 'Business and company websites' if language == 'en' else 
                              ('–ë–∏–∑–Ω–µ—Å –∏ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –≤–µ–±-—Å–∞–π—Ç—ã' if language == 'ru' else 
                               'Gesch√§fts- und Unternehmenswebsites')
            },
            {
                'text': 'Web applications' if language == 'en' else ('–í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è' if language == 'ru' else 'Webanwendungen'),
                'value': 'webapp',
                'description': 'Interactive web-based software' if language == 'en' else 
                              ('–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –≤–µ–±-–ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ' if language == 'ru' else 
                               'Interaktive webbasierte Software')
            },
            {
                'text': 'Back' if language == 'en' else ('–ù–∞–∑–∞–¥' if language == 'ru' else 'Zur√ºck'),
                'value': 'back',
                'description': 'Return to specialist selection' if language == 'en' else 
                              ('–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—ã–±–æ—Ä—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞' if language == 'ru' else 
                               'Zur√ºck zur Spezialistenauswahl')
            }
        ]
        
        return {
            'agent': 'portfolio',
            'answer': greeting,
            'interactive': {
                'text': greeting,
                'buttons': buttons,
                'requires_input': True,
                'meta': {'agent': 'portfolio'}
            }
        }
    
    # Handle specific portfolio categories
    if message.lower() in ['ecommerce', 'corporate', 'webapp']:
        # Show specific portfolio examples based on selection
        portfolio_type = message.lower()
        
        # Map of portfolio responses by type and language
        portfolio_responses = {
            'ecommerce': {
                'en': "Here are our e-commerce projects examples...",
                'ru': "–í–æ—Ç –ø—Ä–∏–º–µ—Ä—ã –Ω–∞—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–æ–≤...",
                'de': "Hier sind unsere E-Commerce-Projektbeispiele..."
            },
            'corporate': {
                'en': "Here are our corporate website examples...",
                'ru': "–í–æ—Ç –ø—Ä–∏–º–µ—Ä—ã –Ω–∞—à–∏—Ö –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö —Å–∞–π—Ç–æ–≤...",
                'de': "Hier sind unsere Beispiele f√ºr Unternehmenswebsites..."
            },
            'webapp': {
                'en': "Here are our web application projects...",
                'ru': "–í–æ—Ç –Ω–∞—à–∏ –ø—Ä–æ–µ–∫—Ç—ã –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π...",
                'de': "Hier sind unsere Webapplikationsprojekte..."
            }
        }
        
        response_text = portfolio_responses[portfolio_type].get(language, portfolio_responses[portfolio_type]['en'])
        
        # Only include a back button
        buttons = [{
            'text': 'Back to portfolio' if language == 'en' else ('–ù–∞–∑–∞–¥ –∫ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ' if language == 'ru' else 'Zur√ºck zum Portfolio'),
            'value': 'portfolio_back',
            'description': 'View other portfolio categories' if language == 'en' else 
                          ('–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥—Ä—É–≥–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ' if language == 'ru' else 
                           'Andere Portfolio-Kategorien anzeigen')
        }]
        
        return {
            'agent': 'portfolio',
            'answer': response_text,
            'interactive': {
                'text': response_text,
                'buttons': buttons,
                'requires_input': True,
                'meta': {'agent': 'portfolio', 'category': portfolio_type}
            }
        }
    
    # If user wants to go back to portfolio main view
    if message.lower() == 'portfolio_back':
        # Clear the selected category
        metadata.pop('category', None)
        # Recursively call without message to get the initial portfolio view
        return handle_portfolio(None, metadata)
    
    # Default case: respond to a general portfolio inquiry
    response_text = "I can show you our portfolio of projects. What type are you interested in seeing?"
    if language == 'ru':
        response_text = "–Ø –º–æ–≥—É –ø–æ–∫–∞–∑–∞—Ç—å –≤–∞–º –Ω–∞—à–µ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ –ø—Ä–æ–µ–∫—Ç–æ–≤. –ö–∞–∫–æ–π —Ç–∏–ø –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?"
    elif language == 'de':
        response_text = "Ich kann Ihnen unser Projektportfolio zeigen. Welchen Typ m√∂chten Sie sehen?"
    
    # Include portfolio category buttons again
    buttons = [
        {
            'text': 'E-commerce' if language == 'en' else ('–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω—ã' if language == 'ru' else 'E-Commerce'),
            'value': 'ecommerce',
            'description': 'Online stores and marketplaces' if language == 'en' else 
                          ('–û–Ω–ª–∞–π–Ω –º–∞–≥–∞–∑–∏–Ω—ã –∏ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—ã' if language == 'ru' else 
                           'Online-Shops und Marktpl√§tze')
        },
        {
            'text': 'Corporate websites' if language == 'en' else ('–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —Å–∞–π—Ç—ã' if language == 'ru' else 'Unternehmenswebsites'),
            'value': 'corporate',
            'description': 'Business and company websites' if language == 'en' else 
                          ('–ë–∏–∑–Ω–µ—Å –∏ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –≤–µ–±-—Å–∞–π—Ç—ã' if language == 'ru' else 
                           'Gesch√§fts- und Unternehmenswebsites')
        },
        {
            'text': 'Web applications' if language == 'en' else ('–í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è' if language == 'ru' else 'Webanwendungen'),
            'value': 'webapp',
            'description': 'Interactive web-based software' if language == 'en' else 
                          ('–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –≤–µ–±-–ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ' if language == 'ru' else 
                           'Interaktive webbasierte Software')
        },
        {
            'text': 'Back' if language == 'en' else ('–ù–∞–∑–∞–¥' if language == 'ru' else 'Zur√ºck'),
            'value': 'back',
            'description': 'Return to specialist selection' if language == 'en' else 
                          ('–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—ã–±–æ—Ä—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞' if language == 'ru' else 
                           'Zur√ºck zur Spezialistenauswahl')
        }
    ]
    
    return {
        'agent': 'portfolio',
        'answer': response_text,
        'interactive': {
            'text': response_text,
            'buttons': buttons,
            'requires_input': True,
            'meta': {'agent': 'portfolio'}
        }
    }

def handle_tech_spec_creation(message, metadata):
    """Handle the technical specification creation process"""
    language = metadata.get('language', 'en')
    
    # Get or initialize the tech spec template
    template = TechSpecTemplate(language)
    
    # Check if this is the first interaction with the tech spec creator
    if not metadata.get('tech_spec_started'):
        # Mark that we've started the tech spec creation process
        metadata['tech_spec_started'] = True
        metadata['tech_spec_section'] = 0
        metadata['tech_spec_answers'] = []
        
        # Initial greeting
        greeting = "Let's create a technical specification for your project. I'll ask you a series of questions."
        if language == 'ru':
            greeting = "–î–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –¥–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞. –Ø –∑–∞–¥–∞–º –≤–∞–º —Ä—è–¥ –≤–æ–ø—Ä–æ—Å–æ–≤."
        elif language == 'de':
            greeting = "Lassen Sie uns eine technische Spezifikation f√ºr Ihr Projekt erstellen. Ich werde Ihnen eine Reihe von Fragen stellen."
        
        # Start with the first question
        current_section = template.sections[0]
        first_question = current_section['title']
        
        # Combine greeting and first question
        full_response = f"{greeting}\n\n{first_question}"
        
        return {
            'agent': 'requirements',
            'answer': full_response,
            'interactive': {
                'text': full_response,
                'buttons': [],
                'requires_input': True,
                'meta': {'agent': 'requirements'}
            }
        }
    
    # Process the answer to the current question
    current_section_index = metadata.get('tech_spec_section', 0)
    answers = metadata.get('tech_spec_answers', [])
    
    # Store the user's answer for the current section
    if current_section_index < len(template.sections):
        answers.append(message)
        metadata['tech_spec_answers'] = answers
    
    # Advance to the next section
    current_section_index += 1
    metadata['tech_spec_section'] = current_section_index
    
    # Check if we've completed all sections
    if current_section_index >= len(template.sections):
        # Tech spec complete
        thank_message = "Thank you! Your technical specification has been created and sent to our team."
        if language == 'ru':
            thank_message = "–°–ø–∞—Å–∏–±–æ! –í–∞—à–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞—à–µ–π –∫–æ–º–∞–Ω–¥–µ."
        elif language == 'de':
            thank_message = "Vielen Dank! Ihre technische Spezifikation wurde erstellt und an unser Team gesendet."
        
        # Prepare tech spec data for notification
        tech_spec_data = {
            'answers': []
        }
        
        # Format each question-answer pair
        template = TechSpecTemplate(metadata.get('language', 'en'))
        answers = metadata.get('tech_spec_answers', [])
        
        # Extract contact information from the answers
        user_name = None
        user_email = None
        user_phone = None
        
        # Last section should be Contact Information
        contact_section_index = len(template.sections) - 1
        if contact_section_index < len(answers):
            contact_info = answers[contact_section_index].split('\n')
            if len(contact_info) >= 2:
                user_name = contact_info[0].strip()
                user_email = contact_info[1].strip()
                if len(contact_info) >= 3:
                    user_phone = contact_info[2].strip()
        
        # Add all sections to the tech spec data
        for i, section in enumerate(template.sections):
            if i < len(answers):
                tech_spec_data['answers'].append({
                    'question': section['title'],
                    'answer': answers[i]
                })
        
        # Add language information for proper template loading
        tech_spec_data['language'] = metadata.get('language', 'en')
        
        # Prepare contact information for the notification
        contact_info = {
            'name': user_name,
            'email': user_email,
            'phone': user_phone
        }
        
        # –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥: –ø—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é, –≤ —Å–ª—É—á–∞–µ –Ω–µ—É–¥–∞—á–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—á–µ—Ä–µ–¥—å
        from app.utils.telegram_queue import send_telegram_message_with_retry
        
        try:
            # –°–Ω–∞—á–∞–ª–∞ –ø–æ–ø—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é
            success = send_tech_spec_notification(tech_spec_data, contact_info)
            if success:
                current_app.logger.info(f"Technical specification notification SENT directly for {user_email}")
            else:
                # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø—Ä—è–º—É—é, –ø–æ–º–µ—â–∞–µ–º –≤ –æ—á–µ—Ä–µ–¥—å
                message_content = send_tech_spec_notification(tech_spec_data, contact_info, return_message_only=True)
                from app.utils.telegram_queue import queue_telegram_message
                queue_telegram_message(message_content)
                current_app.logger.info(f"Technical specification notification QUEUED for {user_email} (direct send failed)")
        except Exception as e:
            current_app.logger.error(f"Failed to send Telegram notification: {str(e)}")
        
        # –û—á–∏—â–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
        metadata.pop('tech_spec_started', None)
        metadata.pop('tech_spec_section', None)
        
        return {
            'agent': 'requirements',
            'answer': thank_message,
            'interactive': {
                'text': thank_message,
                'buttons': [],
                'requires_input': True,
                'show_restart': True,
                'meta': {'agent': 'requirements'}
            }
        }
        
    # Continue with the next question
    current_section = template.sections[current_section_index]
    next_question = current_section['title']
    
    return {
        'agent': 'requirements',
        'answer': next_question,
        'interactive': {
            'text': next_question,
            'buttons': [],
            'requires_input': True,
            'meta': {'agent': 'requirements'}
        }
    }

def handle_quiz(message, metadata):
    """Handle the website cost calculation quiz"""
    language = metadata.get('language', 'en')
    
    # Check if this is the first interaction with the quiz
    if not metadata.get('quiz_started'):
        # Mark that we've started the quiz
        metadata['quiz_started'] = True
        metadata['quiz_step'] = 0
        metadata['quiz_answers'] = []
        
        # Define the quiz structure here or load from a configuration
        quiz_config = [
            {
                'question': {
                    'en': "What type of website do you need?",
                    'ru': "–ö–∞–∫–æ–π —Ç–∏–ø —Å–∞–π—Ç–∞ –≤–∞–º –Ω—É–∂–µ–Ω?",
                    'de': "Welche Art von Website ben√∂tigen Sie?"
                },
                'choices': [
                    {
                        'text': {'en': "Landing page", 'ru': "–õ–µ–Ω–¥–∏–Ω–≥", 'de': "Landingpage"},
                        'value': "landing",
                        'cost': 500
                    },
                    {
                        'text': {'en': "Corporate website", 'ru': "–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —Å–∞–π—Ç", 'de': "Unternehmenswebsite"},
                        'value': "corporate",
                        'cost': 1200
                    },
                    {
                        'text': {'en': "E-commerce", 'ru': "–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω", 'de': "E-Commerce"},
                        'value': "ecommerce",
                        'cost': 2000
                    },
                    {
                        'text': {'en': "Web application", 'ru': "–í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", 'de': "Webanwendung"},
                        'value': "webapp",
                        'cost': 3000
                    }
                ]
            },
            {
                'question': {
                    'en': "Do you need a custom design?",
                    'ru': "–ù—É–∂–µ–Ω –ª–∏ –≤–∞–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω?",
                    'de': "Ben√∂tigen Sie ein individuelles Design?"
                },
                'choices': [
                    {
                        'text': {'en': "Template-based", 'ru': "–ù–∞ –æ—Å–Ω–æ–≤–µ —à–∞–±–ª–æ–Ω–∞", 'de': "Basierend auf einer Vorlage"},
                        'value': "template",
                        'cost': 0
                    },
                    {
                        'text': {'en': "Custom design", 'ru': "–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω", 'de': "Individuelles Design"},
                        'value': "custom",
                        'cost': 800
                    },
                    {
                        'text': {'en': "Premium custom design", 'ru': "–ü—Ä–µ–º–∏—É–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω", 'de': "Premium individuelles Design"},
                        'value': "premium",
                        'cost': 1500
                    }
                ]
            },
            {
                'question': {
                    'en': "Do you need additional features?",
                    'ru': "–ù—É–∂–Ω—ã –ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏?",
                    'de': "Ben√∂tigen Sie zus√§tzliche Funktionen?"
                },
                'choices': [
                    {
                        'text': {'en': "Basic functionality", 'ru': "–ë–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å", 'de': "Grundfunktionalit√§t"},
                        'value': "basic",
                        'cost': 0
                    },
                    {
                        'text': {'en': "CMS integration", 'ru': "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è CMS", 'de': "CMS-Integration"},
                        'value': "cms",
                        'cost': 500
                    },
                    {
                        'text': {'en': "Advanced features", 'ru': "–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏", 'de': "Erweiterte Funktionen"},
                        'value': "advanced",
                        'cost': 1200
                    },
                    {
                        'text': {'en': "Custom functionality", 'ru': "–ù–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å", 'de': "Benutzerdefinierte Funktionalit√§t"},
                        'value': "custom_func",
                        'cost': 2000
                    }
                ]
            }
        ]
        
        # Store the quiz configuration in metadata
        metadata['quiz_config'] = quiz_config
        
        # Show the first quiz question
        first_step = quiz_config[0]
        question = first_step['question'].get(language, first_step['question']['en'])
        
        # Create buttons from the choices
        buttons = []
        for choice in first_step['choices']:
            buttons.append({
                'text': choice['text'].get(language, choice['text']['en']),
                'value': choice['value'],
                'description': ''
            })
        
        return {
            'agent': 'quiz',
            'answer': question,
            'interactive': {
                'text': question,
                'buttons': buttons,
                'requires_input': True,
                'meta': {'agent': 'quiz'}
            }
        }
    
    # Process the answer to the current question
    current_step = metadata.get('quiz_step', 0)
    quiz_config = metadata.get('quiz_config', [])
    answers = metadata.get('quiz_answers', [])
    
    # Find the choice that was selected and store its value and cost
    selected_choice = None
    current_question = quiz_config[current_step]
    
    for choice in current_question['choices']:
        if choice['value'] == message:
            selected_choice = choice
            break
    
    # If no valid choice was selected, provide an error message
    if not selected_choice:
        error_msg = "Please select one of the available options."
        if language == 'ru':
            error_msg = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤."
        elif language == 'de':
            error_msg = "Bitte w√§hlen Sie eine der verf√ºgbaren Optionen."
        
        # Recreate buttons for the current question
        buttons = []
        for choice in current_question['choices']:
            buttons.append({
                'text': choice['text'].get(language, choice['text']['en']),
                'value': choice['value'],
                'description': ''
            })
        
        return {
            'agent': 'quiz',
            'answer': error_msg,
            'interactive': {
                'text': error_msg,
                'buttons': buttons,
                'requires_input': True,
                'meta': {'agent': 'quiz'}
            }
        }
    
    # Store the answer
    answers.append({
        'question': current_question['question'].get(language, current_question['question']['en']),
        'answer': selected_choice['text'].get(language, selected_choice['text']['en']),
        'value': selected_choice['value'],
        'cost': selected_choice['cost']
    })
    metadata['quiz_answers'] = answers
    
    # Move to the next question
    current_step += 1
    metadata['quiz_step'] = current_step
    
    # Check if we've completed all questions
    if current_step >= len(quiz_config):
        # Calculate the total cost
        total_cost = sum(answer['cost'] for answer in answers)
        
        # Format the result message
        result_msg = f"Based on your answers, the estimated cost of your website is ${total_cost}."
        if language == 'ru':
            result_msg = f"–ù–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤, –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤–∞—à–µ–≥–æ —Å–∞–π—Ç–∞ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç ${total_cost}."
        elif language == 'de':
            result_msg = f"Basierend auf Ihren Antworten betr√§gt die gesch√§tzte Kosten Ihrer Website ${total_cost}."
        
        # Add summary of selections
        result_msg += "\n\n"
        if language == 'en':
            result_msg += "Summary of your choices:"
        elif language == 'ru':
            result_msg += "–°–≤–æ–¥–∫–∞ –≤–∞—à–∏—Ö –≤—ã–±–æ—Ä–æ–≤:"
        elif language == 'de':
            result_msg += "Zusammenfassung Ihrer Auswahl:"
        
        for answer in answers:
            result_msg += f"\n- {answer['question']}: {answer['answer']}"
        
        # Add a call to action
        if language == 'en':
            result_msg += "\n\nWould you like to discuss your project with our team?"
        elif language == 'ru':
            result_msg += "\n\n–•–æ—Ç–∏—Ç–µ –æ–±—Å—É–¥–∏—Ç—å –≤–∞—à –ø—Ä–æ–µ–∫—Ç —Å –Ω–∞—à–µ–π –∫–æ–º–∞–Ω–¥–æ–π?"
        elif language == 'de':
            result_msg += "\n\nM√∂chten Sie Ihr Projekt mit unserem Team besprechen?"
        
        # Provide contact buttons
        buttons = [
            {
                'text': 'Contact us' if language == 'en' else ('–°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏' if language == 'ru' else 'Kontaktieren Sie uns'),
                'value': 'contact',
                'description': 'Get in touch with our team' if language == 'en' else 
                              ('–°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞—à–µ–π –∫–æ–º–∞–Ω–¥–æ–π' if language == 'ru' else 
                               'Nehmen Sie Kontakt mit unserem Team auf')
            },
            {
                'text': 'Restart quiz' if language == 'en' else ('–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç' if language == 'ru' else 'Quiz neu starten'),
                'value': 'restart_quiz',
                'description': 'Start the cost calculator again' if language == 'en' else 
                              ('–ù–∞—á–∞—Ç—å –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∑–∞–Ω–æ–≤–æ' if language == 'ru' else 
                               'Starten Sie den Kostenrechner erneut')
            }
        ]
        
        # Clear quiz state but keep the answers for reference
        metadata.pop('quiz_started', None)
        metadata.pop('quiz_step', None)
        
        return {
            'agent': 'quiz',
            'answer': result_msg,
            'interactive': {
                'text': result_msg,
                'buttons': buttons,
                'requires_input': True,
                'meta': {'agent': 'quiz', 'completed': True, 'total_cost': total_cost}
            }
        }
    
    # Show the next question
    next_step = quiz_config[current_step]
    question = next_step['question'].get(language, next_step['question']['en'])
    
    # Create buttons from the choices
    buttons = []
    for choice in next_step['choices']:
        buttons.append({
            'text': choice['text'].get(language, choice['text']['en']),
            'value': choice['value'],
            'description': ''
        })
    
    return {
        'agent': 'quiz',
        'answer': question,
        'interactive': {
            'text': question,
            'buttons': buttons,
            'requires_input': True,
            'meta': {'agent': 'quiz'}
        }
    }

def send_tech_spec_notification(tech_spec_data, contact_info, return_message_only=False):
    """Send a notification about a new technical specification submission"""
    # Format the message
    message = "üîî New Technical Specification Submission\n\n"
    
    # Add contact information
    message += "üë§ Contact Information:\n"
    message += f"Name: {contact_info.get('name', 'N/A')}\n"
    message += f"Email: {contact_info.get('email', 'N/A')}\n"
    message += f"Phone: {contact_info.get('phone', 'N/A')}\n\n"
    
    # Add technical specification answers
    message += "üìã Technical Specification:\n"
    for item in tech_spec_data['answers']:
        message += f"\n‚ùì {item['question']}\n"
        message += f"‚û°Ô∏è {item['answer']}\n"
    
    # Add timestamp
    from datetime import datetime
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    message += f"\nüìÖ Submitted on: {timestamp}"
    
    # If we only need the message content, return it
    if return_message_only:
        return message
    
    # Otherwise, try to send the message
    try:
        from app.services.telegram_service import send_telegram_message
        return send_telegram_message(message)
    except Exception as e:
        logger.error(f"Failed to send tech spec notification: {e}")
        return False
