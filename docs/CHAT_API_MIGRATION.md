# Миграция с Assistants API на Chat Completion API

## Причины изменений

OpenAI планирует прекратить поддержку старых форматов assistant_id (asst_*), поэтому мы мигрируем на прямые вызовы Chat Completion API с сохранением истории сообщений.

## Архитектурные изменения

### Было:
- Использование OpenAI Assistants API с предустановленными assistant_id
- Использование Threads API для управления историей диалога
- Сохранение только mapping между conversation_id и thread_id

### Стало:
- Прямые вызовы Chat Completion API с системными промптами
- Хранение истории сообщений в собственной базе данных
- Эмуляция thread_id для совместимости

## Основные компоненты

1. **Системные промпты** для каждого типа агента:
   - greeter - приветствующий агент
   - spec - помощник по техническим заданиям
   - pm - менеджер проектов

2. **Модели данных**:
   - `AssistantThread` - маппинг между conversation_id и thread_id
   - `ChatMessage` - история сообщений для каждого треда

3. **API методы**:
   - `get_or_create_thread` - создаёт запись в БД
   - `add_user_message` - добавляет сообщение пользователя в историю
   - `run_with_assistant` - генерирует ответ через Chat Completion API

## Преимущества нового подхода

1. **Независимость от устаревающих API** - мы не привязаны к Assistants API
2. **Гибкость в настройке промптов** - можно легко менять поведение агентов
3. **Контроль над историей сообщений** - храним историю в собственной БД
4. **Резервное копирование модели** - поддержка автоматического перехода на запасную модель

## Требования к развертыванию

1. Применить миграцию базы данных: `flask db upgrade`
2. Убедиться, что в .env файле указаны переменные:
   ```
   OPENAI_API_KEY=your_api_key
   ```

3. При необходимости настроить модели в `assistants_service.py`:
   ```python
   DEFAULT_MODEL = "gpt-4o-2024-05-13"  # Основная модель
   FALLBACK_MODEL = "gpt-3.5-turbo"  # Запасная модель
   ```

## Обратная совместимость

Код поддерживает обратную совместимость со старой системой через:
- Сохранение тех же имён методов и параметров
- Эмуляцию thread_id вместо реальных ID от OpenAI
- Сохранение логики переключения между агентами

## Планы на будущее

1. **Расширение функциональности агентов** через обновление системных промптов
2. **Оптимизация хранения истории сообщений** с автоматическим удалением устаревших записей
3. **Интеграция функций (function calling)** для взаимодействия с API и базами данных
