# Деплой проекта Rozoom-KI на Render.com

## Подготовка проекта

1. Настроены следующие файлы:
   - `render.yaml` - конфигурация для автоматического деплоя
   - `gunicorn_config.py` - настройки для WSGI-сервера
   - `requirements.txt` - расширен необходимыми зависимостями
   - `render_start.sh` - скрипт инициализации и запуска
   - `init_postgres_schemas.py` - создание необходимых схем PostgreSQL

2. Приложение настроено для работы с PostgreSQL на Render.com

## Инструкции по деплою

### Вариант 1: Автоматический деплой через Blueprint (render.yaml)

1. Войдите в аккаунт на Render.com
2. Перейдите в раздел Blueprints
3. Нажмите "New Blueprint"
4. Выберите репозиторий GitHub с проектом Rozoom-KI
5. Render автоматически обнаружит файл render.yaml и предложит настройки деплоя
6. Проверьте настройки и нажмите "Apply"
7. Для секретных переменных окружения (отмеченных как `sync: false`) введите значения вручную

### Вариант 2: Ручной деплой

1. Войдите в аккаунт на Render.com
2. Создайте новую PostgreSQL базу данных:
   - Перейдите в раздел "PostgreSQL" и нажмите "New PostgreSQL"
   - Укажите имя "rozoom-ki-db"
   - После создания базы скопируйте строку подключения

3. Создайте новый веб-сервис:
   - Перейдите в раздел "Web Services" и нажмите "New Web Service"
   - Выберите репозиторий GitHub с проектом Rozoom-KI
   - Укажите имя "rozoom-ki"
   - Выберите тип "Python"
   - Команда сборки: `pip install -r requirements.txt`
   - Команда запуска: `bash render_start.sh`
   - Добавьте все переменные окружения из файла .env
   - В качестве DATABASE_URL укажите строку подключения от созданной базы данных

4. Нажмите "Create Web Service" для запуска деплоя

## Проверка деплоя

После успешного деплоя:
1. Проверьте логи сервиса на наличие ошибок
2. Убедитесь, что приложение отвечает на эндпоинт `/health`
3. Проверьте работу основного функционала

## Решение проблем с миграциями

При первом деплое на Render.com часто возникают проблемы с миграциями базы данных, особенно при переходе с SQLite на PostgreSQL. Для решения этих проблем созданы специальные скрипты:

1. **fix_migrations.sh** - комплексный скрипт для исправления проблем с миграциями
2. **direct_start.sh** - альтернативный скрипт запуска без использования миграций
3. **fix_migration_issue.py** - скрипт для исправления проблемы с таблицей `alembic_version`
4. **fix_alembic_revision.py** - скрипт для создания пустой ревизии с ID 'ac4cda9e7cef'

### Исправление ошибки "Не удается найти ревизию, идентифицированную как 'ac4cda9e7cef'"

Эта ошибка возникает, когда в таблице `alembic_version` есть ссылка на ревизию, которой нет в текущих файлах миграций. Система деплоя автоматически пытается исправить эту проблему двумя способами:

1. Очистка таблицы `alembic_version` (с помощью `fix_migration_issue.py`)
2. Создание пустой ревизии с проблемным ID (с помощью `fix_alembic_revision.py`)

Если автоматическое исправление не срабатывает, приложение запускается через скрипт `direct_start.sh`, который создает таблицы напрямую через SQLAlchemy, минуя систему миграций.

При возникновении других ошибок см. подробные инструкции в файле `MIGRATION_FIX.md`.

## Миграция данных (при необходимости)

Если вам нужно перенести данные из локальной SQLite базы в PostgreSQL:

1. Используйте скрипт для переноса данных:
   ```
   python setup_postgres_tables.py --sqlite=dev.db
   ```

2. Или используйте ручной экспорт/импорт:
   ```
   # Экспорт данных из SQLite
   python -c "from app import create_app, db; app = create_app(); app.app_context().push(); from app.models import *; import json; print(json.dumps([{k: v for k, v in m.__dict__.items() if not k.startswith('_')} for m in Model.query.all()]))" > data.json
   ```

## Мониторинг и поддержка

- Используйте Render Dashboard для мониторинга использования ресурсов
- Настройте оповещения о проблемах
- Регулярно обновляйте зависимости для безопасности
